<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گزارش درآمد ارائه‌دهندگان خدمات اعتباری</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .persian-number {
            font-family: 'Vazirmatn', sans-serif;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn-primary {
            background-color: #3B82F6;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #2563EB;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .month-label {
            font-size: 14px;
            font-weight: 500;
        }
        
        .prediction-line {
            border-style: dashed !important;
            border-width: 2px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- هدر -->
        <div class="header">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">گزارش درآمد ارائه‌دهندگان خدمات اعتباری</h1>
                    <p class="mt-2 opacity-90">بررسی و برآورد درآمد محقق شده و در راه</p>
                </div>
                <div class="text-left">
                    <p class="text-lg">تاریخ حال: <span class="font-bold">30 آذر 1402</span></p>
                    <p class="text-sm opacity-90">بازه شبیه‌سازی: 1 مهر تا 1 اسفند 1402</p>
                </div>
            </div>
        </div>
        
        <!-- دکمه به‌روزرسانی -->
        <div class="flex justify-end mb-6">
            <button id="refreshBtn" class="btn-primary flex items-center">
                <i class="fas fa-sync-alt ml-2"></i>
                به‌روزرسانی داده‌ها
            </button>
        </div>
        
        <!-- نمودار خطی -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4 text-gray-800">روند روزانه درآمد موفق</h2>
            <p class="text-gray-600 mb-6">نمودار خطی نمایش‌دهنده مبالغ دریافتی موفق روزانه از 1 مهر تا 30 آذر  </p>
            <div class="chart-container">
                <canvas id="lineChart"></canvas>
            </div>
            <div class="mt-4 text-sm text-gray-500 flex items-center">
                <div class="flex items-center ml-4">
                    <div class="w-4 h-1 bg-blue-500 ml-2"></div>
                    <span>داده‌های واقعی (1 مهر تا 30 آذر)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-1 border-dashed border-blue-500 border ml-2"></div>
                    <span>پیش‌بینی 7 روز آینده</span>
                </div>
            </div>
        </div>
        
        <!-- نمودار میله‌ای -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4 text-gray-800">درآمدهای قابل واریز ماهانه</h2>
            <p class="text-gray-600 mb-6">درآمدهای موفق هر ماه که در تاریخ 20 ماه بعد واریز می‌شوند. رنگ پررنگ نشان‌دهنده واریز شده است.</p>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
            <div class="mt-4 text-sm text-gray-500 flex items-center">
                <div class="flex items-center ml-4">
                    <div class="w-4 h-4 bg-blue-600 ml-2"></div>
                    <span>واریز شده (قابل برداشت)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-blue-300 ml-2"></div>
                    <span>در انتظار واریز (آینده)</span>
                </div>
            </div>
        </div>
        
        <!-- توضیحات -->
        <div class="card">
            <h3 class="text-lg font-bold mb-3 text-gray-800">نحوه محاسبه و منطق گزارش</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-bold mb-2 text-blue-600">نمودار خطی:</h4>
                    <ul class="list-disc pr-5 text-gray-700 space-y-2">
                        <li>داده‌ها با توزیع نرمال با میانگین 2 میلیون تومان و انحراف معیار 200 هزار تومان تولید شده‌اند</li>
                        <li>بازه تاریخی: 90 روز از 1 مهر تا 30 آذر 1402</li>
                        <li>پیش‌بینی: 7 روز آینده (1 تا 7 دی) با خطچین نمایش داده شده است</li>
                        <li>با هر بار کلیک روی دکمه "به‌روزرسانی داده‌ها"، اعداد تصادفی جدید تولید می‌شوند</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-2 text-blue-600">نمودار میله‌ای:</h4>
                    <ul class="list-disc pr-5 text-gray-700 space-y-2">
                        <li>جمع درآمدهای موفق هر ماه شمسی محاسبه شده است</li>
                        <li>هر ماه در تاریخ 20 ماه بعد واریز می‌شود (مثلاً درآمد مهر در 20 آبان واریز می‌شود)</li>
                        <li>رنگ آبی پررنگ: ماه‌هایی که تاریخ واریز آنها گذشته است (مهر و آبان)</li>
                        <li>رنگ آبی کمرنگ: ماه‌هایی که هنوز تاریخ واریز آنها نرسیده است (آذر تا اسفند)</li>
                        <li>تاریخ حال: 30 آذر 1402 در نظر گرفته شده است</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تنظیمات اولیه
        const mean = 2000000; // میانگین 2 میلیون تومان
        const stdDev = 1000000; // انحراف معیار 1 میلیون تومان
        const historicalDays = 90; // از 1 مهر تا 30 آذر (3 ماه 30 روزه)
        const predictionDays = 7; // 7 روز آینده
        const months = ['مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
        
        // تاریخ‌های واریز برای هر ماه (20م ماه بعد)
        const payoutDates = {
            'مهر': '20 آبان',
            'آبان': '20 آذر', 
            'آذر': '20 دی',
            'دی': '20 بهمن',
            'بهمن': '20 اسفند',
            'اسفند': '20 فروردین'
        };
        
        // وضعیت واریز هر ماه بر اساس تاریخ حال (30 آذر)
        const payoutStatus = {
            'مهر': true,   // واریز شده (20 آبان < 30 آذر)
            'آبان': true,  // واریز شده (20 آذر < 30 آذر)
            'آذر': true,  // واریز نشده (20 دی > 30 آذر)
            'دی': false,   // واریز نشده
            'بهمن': false, // واریز نشده
            'اسفند': false // واریز نشده
        };
        
        // تولید عدد تصادفی با توزیع نرمال (Box-Muller transform)
        function generateNormalRandom(mean, stdDev) {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            let num = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return num * stdDev + mean;
        }
        
        // تولید داده‌های روزانه
        function generateDailyData(days) {
            const data = [];
            for(let i = 0; i < days; i++) {
                // تولید عدد تصادفی با توزیع نرمال
                let randomValue = generateNormalRandom(mean, stdDev);
                
                // جلوگیری از اعداد منفی
                if(randomValue < 0) randomValue = mean * 0.1;
                
                data.push(Math.round(randomValue));
            }
            return data;
        }
        
        // محاسبه درآمد ماهانه از داده‌های روزانه
        function calculateMonthlyData(dailyData) {
            const monthlyData = [];
            
            // هر ماه 30 روز است
            for(let month = -1; month < 6; month++) {
                let monthlySum = 0;
                const startIdx = month * 30;
                const endIdx = startIdx + 30;
                
                // اگر داده کافی وجود دارد، جمع بزن
                if(startIdx < dailyData.length) {
                    const actualEndIdx = Math.min(endIdx, dailyData.length);
                    for(let i = startIdx; i < actualEndIdx; i++) {
                        monthlySum += dailyData[i];
                    }
                    
                    // اگر داده کافی نداریم، برای روزهای باقیمانده میانگین بگیر
                    if(actualEndIdx < endIdx) {
                        const remainingDays = endIdx - actualEndIdx;
                        const avg = monthlySum / (actualEndIdx - startIdx);
                        monthlySum += avg * remainingDays;
                    }
                }
                
                monthlyData.push(Math.round(monthlySum));
            }
            
            return monthlyData;
        }
        
        // تولید برچسب‌های روز برای نمودار خطی
        function generateDayLabels(historicalDays, predictionDays) {
            const labels = [];
            
            // برچسب‌های تاریخی (1 مهر تا 30 آذر)
            for(let i = 1; i <= historicalDays; i++) {
                // محاسبه روز و ماه
                let dayInMonth = i % 30;
                if(dayInMonth === 0) dayInMonth = 30;
                
                const monthIndex = Math.floor((i - 1) / 30);
                
                if(dayInMonth === 1 || dayInMonth === 15 || dayInMonth === 30) {
                    labels.push(`${dayInMonth} ${months[monthIndex]}`);
                } else {
                    labels.push('');
                }
            }
            
            // برچسب‌های پیش‌بینی (1 دی تا 7 دی)
            // for(let i = 1; i <= predictionDays; i++) {
            //     if(i === 1 || i === 4 || i === 7) {
            //         labels.push(`${i} دی`);
            //     } else {
            //         labels.push('');
            //     }
            // }
            
            return labels;
        }
        
        // فرمت کردن اعداد به صورت مالی
        function formatCurrency(value) {
            return new Intl.NumberFormat('fa-IR').format(value) + ' تومان';
        }
        
        // فرمت کوتاه اعداد
        function formatShortCurrency(value) {
            if(value >= 1000000000) {
                return (value / 1000000000).toFixed(1) + ' میلیارد';
            } else if(value >= 1000000) {
                return (value / 1000000).toFixed(1) + ' میلیون';
            } else if(value >= 1000) {
                return (value / 1000).toFixed(1) + ' هزار';
            }
            return value.toString();
        }
        
        // متغیرهای جهانی برای نگهداری داده‌ها و نمودارها
        let dailyData = [];
        let monthlyData = [];
        let lineChartInstance = null;
        let barChartInstance = null;
        
        // مقداردهی اولیه و تولید داده
        function initializeData() {
            // تولید داده روزانه برای 97 روز (90 روز تاریخی + 7 روز پیش‌بینی)
            dailyData = generateDailyData(historicalDays + predictionDays);
            
            // محاسبه داده ماهانه از 90 روز اول (6 ماه)
            monthlyData = calculateMonthlyData(dailyData.slice(0, historicalDays));
            
            // ایجاد نمودارها
            createCharts();
        }
        
        // ایجاد نمودار خطی
        function createLineChart() {
            const ctx = document.getElementById('lineChart').getContext('2d');
            
            // جداسازی داده‌های تاریخی و پیش‌بینی
            const historicalData = dailyData.slice(0, historicalDays);
            const predictionData = dailyData.slice(historicalDays, historicalDays + predictionDays);
            
            // ایجاد آرایه داده کامل برای نمودار
            const allData = [...historicalData, ...predictionData];
            
            // ایجاد آرایه رنگ‌ها
            const backgroundColors = [];
            const borderColors = [];
            
            // رنگ‌بندی برای داده‌های تاریخی
            for(let i = 0; i < historicalDays; i++) {
                backgroundColors.push('rgba(59, 130, 246, 0.1)');
                borderColors.push('rgba(59, 130, 246, 1)');
            }
            
            // رنگ‌بندی برای داده‌های پیش‌بینی
            for(let i = 0; i < predictionDays; i++) {
                backgroundColors.push('rgba(59, 130, 246, 0.05)');
                borderColors.push('rgba(59, 130, 246, 0.7)');
            }
            
            if(lineChartInstance) {
                lineChartInstance.destroy();
            }
            
            lineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: generateDayLabels(historicalDays, predictionDays),
                    datasets: [{
                        label: 'درآمد روزانه',
                        data: allData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: borderColors,
                        fill: true,
                        tension: 0.2,
                        // تنظیم خطچین برای بخش پیش‌بینی
                        borderDash: (ctx) => {
                            const index = ctx.dataIndex;
                            return index >= historicalDays ? [5, 5] : [];
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: false,
                                callback: function(value, index, values) {
                                    return this.getLabelForValue(index);
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatShortCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = 'درآمد: ' + formatCurrency(context.parsed.y);
                                    
                                    // تعیین نوع داده (تاریخی یا پیش‌بینی)
                                    if(context.dataIndex < historicalDays) {
                                        label += ' (داده تاریخی)';
                                    } else {
                                        label += ' (پیش‌بینی)';
                                    }
                                    
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ایجاد نمودار میله‌ای
        function createBarChart() {
            const ctx = document.getElementById('barChart').getContext('2d');
            
            // ایجاد آرایه رنگ‌ها بر اساس وضعیت واریز
            const backgroundColors = months.map(month => {
                return payoutStatus[month] ? 'rgba(59, 130, 246, 0.8)' : 'rgba(147, 197, 253, 0.8)';
            });
            
            const borderColors = months.map(month => {
                return payoutStatus[month] ? 'rgba(59, 130, 246, 1)' : 'rgba(147, 197, 253, 1)';
            });
            
            if(barChartInstance) {
                barChartInstance.destroy();
            }
            
            barChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'درآمد ماهانه',
                        data: monthlyData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatShortCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const month = months[context.dataIndex];
                                    let label = 'درآمد ماه ' + month + ': ' + formatCurrency(context.parsed.y);
                                    label += '\nتاریخ واریز: ' + payoutDates[month];
                                    label += '\nوضعیت: ' + (payoutStatus[month] ? 'واریز شده' : 'در انتظار واریز');
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ایجاد هر دو نمودار
        function createCharts() {
            createLineChart();
            createBarChart();
        }
        
        // رویداد کلیک برای دکمه به‌روزرسانی
        document.getElementById('refreshBtn').addEventListener('click', function() {
            // نمایش انیمیشن روی دکمه
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> در حال به‌روزرسانی...';
            btn.disabled = true;
            
            // تولید داده‌های جدید
            setTimeout(() => {
                dailyData = generateDailyData(historicalDays + predictionDays);
                monthlyData = calculateMonthlyData(dailyData.slice(0, historicalDays));
                
                // به‌روزرسانی نمودارها
                createCharts();
                
                // بازگرداندن دکمه به حالت عادی
                btn.innerHTML = originalHtml;
                btn.disabled = false;
                
                // نمایش پیام موفقیت
                showToast('داده‌ها با موفقیت به‌روزرسانی شدند');
            }, 500);
        });
        
        // نمایش پیام toast
        function showToast(message) {
            // حذف toast قبلی اگر وجود دارد
            const existingToast = document.querySelector('.toast-message');
            if(existingToast) {
                existingToast.remove();
            }
            
            // ایجاد عنصر toast
            const toast = document.createElement('div');
            toast.className = 'toast-message fixed bottom-4 left-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // حذف خودکار بعد از 3 ثانیه
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // مقداردهی اولیه هنگام بارگذاری صفحه
        document.addEventListener('DOMContentLoaded', initializeData);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شبیه‌ساز جریان مالی کیف پول‌ها</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Vazir', 'Tahoma', sans-serif;
            background-color: #f8f9fa;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 15px 15px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: #4d79ff;
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #4d79ff;
            border-color: #4d79ff;
        }
        .btn-primary:hover {
            background-color: #3a5fcc;
            border-color: #3a5fcc;
        }
        .form-label {
            font-weight: 500;
        }
        .table th {
            background-color: #e9ecef;
        }
        .wallet-card {
            transition: transform 0.3s;
        }
        .wallet-card:hover {
            transform: translateY(-5px);
        }
        .nav-tabs .nav-link.active {
            background-color: #4d79ff;
            color: white;
            border: none;
        }
        .nav-tabs .nav-link {
            color: #4d79ff;
        }
        .result-section {
            display: none;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        @font-face {
            font-family: 'Vazir';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <div class="container">
            <h1 class="display-4">شبیه‌ساز جریان مالی کیف پول‌ها</h1>
            <p class="lead">تحلیل و شبیه‌سازی جریان‌های مالی بین کیف پول‌های مختلف در مدل کسب‌وکار</p>
            <div>با شرایط بازپرداخت 15 روز از اعتباردهنده به بهترینو و 30 روزه بهترینو به کسب و کار</div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- بخش ورودی‌ها -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        پارامترهای ورودی
                    </div>
                    <div class="card-body">
                        <form id="simulation-form">
                            <div class="mb-3">
                                <label for="excel-file" class="form-label">فایل اکسل داده‌ها</label>
                                <input type="file" class="form-control" id="excel-file" accept=".xlsx, .xls">
                                <div class="form-text">فایل اکسل باید شامل ستون‌های orders #, merchant #, Order Price باشد</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="interest-rate" class="form-label">نرخ بهره سالانه (Interest Rate)</label>
                                <input type="number" class="form-control" id="interest-rate" step="0.001" value="0.025">
                            </div>
                            
                            <div class="mb-3">
                                <label for="margin" class="form-label">حاشیه سود (Margin)</label>
                                <input type="number" class="form-control" id="margin" step="0.01" value="0.6">
                            </div>
                            
                            <div class="mb-3">
                                <label for="commission-behtarino" class="form-label">کمیسیون بهترینو (Commission Behtarino)</label>
                                <input type="number" class="form-control" id="commission-behtarino" step="0.001" value="0.085">
                            </div>
                            
                            <div class="mb-3">
                                <label for="commission-bnpl" class="form-label">کمیسیون BNPL</label>
                                <input type="number" class="form-control" id="commission-bnpl" step="0.001" value="0.06">
                            </div>
                            
                            <div class="mb-3">
                                <label for="default-rate" class="form-label">نرخ عدم پرداخت (Default Rate)</label>
                                <input type="number" class="form-control" id="default-rate" step="0.001" value="0.08">
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" id="run-simulation">اجرای شبیه‌سازی</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        کیف پول‌ها
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="card wallet-card text-center p-2 bg-primary text-white">
                                    <h6>فروشنده</h6>
                                    <small>Merchant</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="card wallet-card text-center p-2 bg-info text-white">
                                    <h6>بهترینو</h6>
                                    <small>Behtarino</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card wallet-card text-center p-2 bg-success text-white">
                                    <h6>BNPL</h6>
                                    <small>Buy Now Pay Later</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card wallet-card text-center p-2 bg-warning text-dark">
                                    <h6>کاربر</h6>
                                    <small>User</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- بخش نتایج -->
            <div class="col-md-8">
                <div class="result-section" id="results">
                    <ul class="nav nav-tabs" id="resultsTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab">نمودارها</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">داده‌ها</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="npv-tab" data-bs-toggle="tab" data-bs-target="#npv" type="button" role="tab">ارزش خالص فعلی</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="charts" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    نمودار جریان درآمدی کیف پول‌ها
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="cashflow-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    نمودار ارزش خالص فعلی (NPV)
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="npv-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="data" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    داده‌های شبیه‌سازی
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="simulation-data">
                                            <thead>
                                                <tr>
                                                    <th>روز</th>
                                                    <th>فروشنده</th>
                                                    <th>بهترینو</th>
                                                    <th>BNPL</th>
                                                    <th>کاربر</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- داده‌ها توسط جاوااسکریپت پر می‌شود -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="npv" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    محاسبه ارزش خالص فعلی (NPV)
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>کیف پول</th>
                                                    <th>ارزش خالص فعلی (NPV)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="npv-results">
                                                <!-- نتایج NPV توسط جاوااسکریپت پر می‌شود -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" id="instructions">
                    <div class="card-header">
                        راهنمای استفاده
                    </div>
                    <div class="card-body">
                        <ol>
                            <li>فایل اکسل خود را با فرمت مناسب آپلود کنید</li>
                            <li>پارامترهای شبیه‌سازی را تنظیم کنید</li>
                            <li>دکمه "اجرای شبیه‌سازی" را کلیک کنید</li>
                            <li>نتایج را در تب‌های مختلف مشاهده کنید</li>
                        </ol>
                        <p class="text-muted">فرمت فایل اکسل باید شامل ستون‌های زیر باشد:</p>
                        <ul>
                            <li>orders # (تعداد سفارش‌ها)</li>
                            <li>merchant # (تعداد فروشندگان)</li>
                            <li>Order Price (قیمت سفارش)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container">
            <p>شبیه‌ساز جریان مالی کیف پول‌ها - طراحی شده برای مدل‌های کسب‌وکار چند کیف پولی</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const runButton = document.getElementById('run-simulation');
            const fileInput = document.getElementById('excel-file');
            const resultsSection = document.getElementById('results');
            const instructionsSection = document.getElementById('instructions');
            
            let cashflowChart = null;
            let npvChart = null;
            
            runButton.addEventListener('click', function() {
                // اعتبارسنجی فایل
                if (!fileInput.files.length) {
                    alert('لطفاً یک فایل اکسل انتخاب کنید');
                    return;
                }
                
                // خواندن پارامترهای ورودی
                const interestRate = parseFloat(document.getElementById('interest-rate').value);
                const margin = parseFloat(document.getElementById('margin').value);
                const commissionBehtarino = parseFloat(document.getElementById('commission-behtarino').value);
                const commissionBNPL = parseFloat(document.getElementById('commission-bnpl').value);
                const defaultRate = parseFloat(document.getElementById('default-rate').value);
                
                // خواندن فایل اکسل
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // فرض می‌کنیم داده‌ها در اولین شیت هستند
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // تبدیل داده‌های اکسل به آرایه
                        const excelData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        // پیدا کردن ستون‌های مورد نیاز
                        let ordersCol = -1, merchantsCol = -1, priceCol = -1;
                        
                        // جستجوی هدرها
                        for (let i = 0; i < Math.min(10, excelData.length); i++) {
                            const row = excelData[i];
                            for (let j = 0; j < row.length; j++) {
                                const cell = String(row[j]).toLowerCase();
                                if (cell.includes('orders') && cell.includes('#')) ordersCol = j;
                                if (cell.includes('merchant') && cell.includes('#')) merchantsCol = j;
                                if (cell.includes('order') && cell.includes('price')) priceCol = j;
                            }
                        }
                        
                        // اگر هدرها پیدا نشدند، فرض می‌کنیم ستون‌ها به ترتیب هستند
                        if (ordersCol === -1) ordersCol = 0;
                        if (merchantsCol === -1) merchantsCol = 1;
                        if (priceCol === -1) priceCol = 4;
                        
                        // استخراج داده‌ها
                        const simulationData = [];
                        let rowIndex = 0;
                        
                        for (let i = 0; i < excelData.length; i++) {
                            const row = excelData[i];
                            if (row.length > Math.max(ordersCol, merchantsCol, priceCol)) {
                                const orders = parseFloat(row[ordersCol]);
                                const merchants = parseFloat(row[merchantsCol]);
                                const orderPrice = parseFloat(row[priceCol]);
                                
                                if (!isNaN(orders) && !isNaN(merchants) && !isNaN(orderPrice)) {
                                    const abv = orders * merchants * orderPrice;
                                    simulationData.push({
                                        day: rowIndex,
                                        orders: orders,
                                        merchants: merchants,
                                        orderPrice: orderPrice,
                                        abv: abv
                                    });
                                    rowIndex++;
                                }
                            }
                        }
                        
                        // اجرای شبیه‌سازی
                        const wallets = runSimulation(
                            simulationData, 
                            interestRate, 
                            margin, 
                            commissionBehtarino, 
                            commissionBNPL, 
                            defaultRate
                        );
                        
                        // نمایش نتایج
                        displayResults(wallets, simulationData);
                        
                        // نمایش بخش نتایج
                        resultsSection.style.display = 'block';
                        instructionsSection.style.display = 'none';
                        
                    } catch (error) {
                        console.error('خطا در پردازش فایل:', error);
                        alert('خطا در پردازش فایل اکسل. لطفاً از فرمت صحیح اطمینان حاصل کنید.');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            });
            
            function runSimulation(data, interestRate, margin, commissionBehtarino, commissionBNPL, defaultRate) {
                // تعریف کیف پول‌ها
                const wallets = {
                    merchant: { inflows: [], outflows: [], net: [] },
                    behtarino: { inflows: [], outflows: [], net: [] },
                    bnpl: { inflows: [], outflows: [], net: [] },
                    user: { inflows: [], outflows: [], net: [] }
                };
                
                // محاسبه حداکثر روز مورد نیاز (با در نظر گرفتن تأخیرها)
                const maxDays = data.length + 60; // 
                
                // مقداردهی اولیه آرایه‌ها
                for (let i = 0; i < maxDays; i++) {
                    wallets.merchant.inflows[i] = 0;
                    wallets.merchant.outflows[i] = 0;
                    wallets.merchant.net[i] = 0;
                    
                    wallets.behtarino.inflows[i] = 0;
                    wallets.behtarino.outflows[i] = 0;
                    wallets.behtarino.net[i] = 0;
                    
                    wallets.bnpl.inflows[i] = 0;
                    wallets.bnpl.outflows[i] = 0;
                    wallets.bnpl.net[i] = 0;
                    
                    wallets.user.inflows[i] = 0;
                    wallets.user.outflows[i] = 0;
                    wallets.user.net[i] = 0;
                }
                
                // پردازش هر روز
                data.forEach(dayData => {
                    const day = dayData.day;
                    const abv = dayData.abv;
                    
                    // روز جاری
                    wallets.merchant.outflows[day] += (1 - margin) * abv;
                    wallets.user.inflows[day] += abv;
                    
                    // روز +60 (کاربر به BNPL)
                    if (day + 60 < maxDays) {
                        wallets.user.outflows[day + 60] += abv * (1 - defaultRate);
                        wallets.bnpl.inflows[day + 60] += abv * (1 - defaultRate);
                    }
                    
                    // روز +15 (BNPL به بهترینو)
                    if (day + 15 < maxDays) {
                        wallets.bnpl.outflows[day + 15] += abv * (1 - commissionBNPL);
                        wallets.behtarino.inflows[day + 15] += abv * (1 - commissionBNPL);
                    }
                    
                    // روز +30 (بهترینو به فروشنده)
                    if (day + 30 < maxDays) {
                        wallets.behtarino.outflows[day + 30] += abv * (1 - (commissionBNPL + commissionBehtarino));
                        wallets.merchant.inflows[day + 30] += abv * (1 - (commissionBNPL + commissionBehtarino));
                    }
                });
                
                // محاسبه خالص جریان نقدی برای هر روز
                for (let i = 0; i < maxDays; i++) {
                    wallets.merchant.net[i] = wallets.merchant.inflows[i] - wallets.merchant.outflows[i];
                    wallets.behtarino.net[i] = wallets.behtarino.inflows[i] - wallets.behtarino.outflows[i];
                    wallets.bnpl.net[i] = wallets.bnpl.inflows[i] - wallets.bnpl.outflows[i];
                    wallets.user.net[i] = wallets.user.inflows[i] - wallets.user.outflows[i];
                }
                
                return wallets;
            }
            
            function displayResults(wallets, simulationData) {
                // محاسبه NPV
                const interestRate = parseFloat(document.getElementById('interest-rate').value);
                const dailyRate = interestRate / 365; // نرخ روزانه
                
                const merchantNPV = calculateNPV(wallets.merchant.net, dailyRate);
                const behtarinoNPV = calculateNPV(wallets.behtarino.net, dailyRate);
                const bnplNPV = calculateNPV(wallets.bnpl.net, dailyRate);
                const userNPV = calculateNPV(wallets.user.net, dailyRate);
                
                // نمایش NPV در جدول
                const npvResults = document.getElementById('npv-results');
                npvResults.innerHTML = `
                    <tr>
                        <td>فروشنده (Merchant)</td>
                        <td>${merchantNPV.toLocaleString('fa-IR')}</td>
                    </tr>
                    <tr>
                        <td>بهترینو (Behtarino)</td>
                        <td>${behtarinoNPV.toLocaleString('fa-IR')}</td>
                    </tr>
                    <tr>
                        <td>BNPL</td>
                        <td>${bnplNPV.toLocaleString('fa-IR')}</td>
                    </tr>
                    <tr>
                        <td>کاربر (User)</td>
                        <td>${userNPV.toLocaleString('fa-IR')}</td>
                    </tr>
                `;
                
                // نمایش داده‌ها در جدول
                const dataTable = document.getElementById('simulation-data');
                const tbody = dataTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                for (let i = 0; i < Math.min(50, wallets.merchant.net.length); i++) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${i + 1}</td>
                        <td>${wallets.merchant.net[i].toLocaleString('fa-IR')}</td>
                        <td>${wallets.behtarino.net[i].toLocaleString('fa-IR')}</td>
                        <td>${wallets.bnpl.net[i].toLocaleString('fa-IR')}</td>
                        <td>${wallets.user.net[i].toLocaleString('fa-IR')}</td>
                    `;
                    tbody.appendChild(row);
                }
                
                // رسم نمودار جریان نقدی
                drawCashflowChart(wallets);
                
                // رسم نمودار NPV
                drawNPVChart([merchantNPV, behtarinoNPV, bnplNPV, userNPV]);
            }
            
            function calculateNPV(cashflows, rate) {
                let npv = 0;
                for (let t = 0; t < cashflows.length; t++) {
                    npv += cashflows[t] / Math.pow(1 + rate, t);
                }
                return npv;
            }
            
            function drawCashflowChart(wallets) {
                const ctx = document.getElementById('cashflow-chart').getContext('2d');
                
                // محدود کردن داده‌ها برای نمایش بهتر
                const displayDays = Math.min(180, wallets.merchant.net.length);
                const labels = Array.from({length: displayDays}, (_, i) => `روز ${i + 1}`);
                
                if (cashflowChart) {
                    cashflowChart.destroy();
                }
                
                cashflowChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'فروشنده',
                                data: wallets.merchant.net.slice(0, displayDays),
                                borderColor: '#4d79ff',
                                backgroundColor: 'rgba(77, 121, 255, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'بهترینو',
                                data: wallets.behtarino.net.slice(0, displayDays),
                                borderColor: '#b80791',
                                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'BNPL',
                                data: wallets.bnpl.net.slice(0, displayDays),
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'کاربر',
                                data: wallets.user.net.slice(0, displayDays),
                                borderColor: '#ffc107',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'جریان نقدی کیف پول‌ها در طول زمان',
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                position: 'top',
                                rtl: true
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'روز'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'جریان نقدی'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('fa-IR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function drawNPVChart(npvValues) {
                const ctx = document.getElementById('npv-chart').getContext('2d');
                
                if (npvChart) {
                    npvChart.destroy();
                }
                
                npvChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['فروشنده', 'بهترینو', 'BNPL', 'کاربر'],
                        datasets: [{
                            label: 'ارزش خالص فعلی (NPV)',
                            data: npvValues,
                            backgroundColor: [
                                'rgba(77, 121, 255, 0.7)',
                                'rgba(23, 162, 184, 0.7)',
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(255, 193, 7, 0.7)'
                            ],
                            borderColor: [
                                'rgb(77, 121, 255)',
                                'rgb(23, 162, 184)',
                                'rgb(40, 167, 69)',
                                'rgb(255, 193, 7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ارزش خالص فعلی (NPV) کیف پول‌ها',
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('fa-IR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>